<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>D3 TEST</title>
    <style>
    .node {
        stroke: #fff;
        stroke-width: 1.5px;
        cursor: pointer;
    }

    .link {
        stroke: #999;
        stroke-opacity: 0.6;
    }

    .node:hover {
        stroke: #000;
        stroke-width: 3px;
    }

    .link:hover {
        stroke: #ff0000;
        stroke-width: 3px;
    }

    .highlighted {
        stroke: #ff0000;
        stroke-width: 3px;
        fill: #ffcccc !important;
    }

    .linked-highlight {
        stroke: #ff0000;
        stroke-opacity: 1;
        stroke-width: 2px;
    }

    .tooltip {
        position: absolute;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        pointer-events: none;
        font-family: Arial, sans-serif;
        font-size: 12px;
        max-width: 200px;
        z-index: 1000;
    }

    .tooltip h3 {
        margin: 0 0 5px 0;
        font-size: 14px;
        color: #333;
    }

    .tooltip p {
        margin: 2px 0;
    }

    .highlight {
        stroke: #ff0000;
        stroke-width: 3px;
    }


    </style>
</head>
<body>
    <div id="graph"></div>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // Данные графа
        const graph = {
            nodes: [
                { id: 0, color: 1, group: "Меценат", name: "Савва Мамонтов", description : "Меценат - Савва Мамонтов"},
                { id: 1, color: 2, group: "Художник", name: "Василий Поленов", description : "Художник - Василий Поленов"},
                { id: 2, color: 2, group: "Художник", name: "Илья Репин", description : "Художник - Илья Репин"},
                { id: 3, color: 3, group: "Музыкант", name: "Сергей Рахманинов", description : "Музыкант - Сергей Рахманинов"},
                { id: 4, color: 3, group: "Учёный", name: "Николай Римский-Корсаков", description :"Учёный - Николай Римский-Корсаков" }
            ],
            links: [
                { source: 0, target: 1 },
                { source: 0, target: 2 },
                { source: 0, target: 3 },
                { source: 0, target: 4 },
                { source: 1, target: 2 }
            ]
        };

        const width = 800, height = 600;

        // Создание SVG
        const svg = d3.select("#graph")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        // Инициализация симуляции
        const simulation = d3.forceSimulation(graph.nodes)
            .force("link", d3.forceLink(graph.links).id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2));

        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // Создание линий (рёбра)
        const link = svg.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(graph.links)
            .enter().append("line")
            .attr("class", "link")
            .attr("stroke-width", 2);

        // Создание узлов
        const node = svg.append("g")
            .attr("class", "nodes")
            .selectAll("circle")
            .data(graph.nodes)
            .enter().append("circle")
            .attr("class", "node")
            .attr("r", 10)
            .attr("fill", d => d3.schemeCategory10[d.color])
            .call(
                d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended)
            );

        // Добавление подписей
        const label = svg.append("g")
            .attr("class", "labels")
            .selectAll("text")
            .data(graph.nodes)
            .enter().append("text")
            .text(d => d.name)
            .attr("font-size", 14)
            .attr("dx", 0)
            .attr("dy", 20)
            .attr("text-anchor", "middle")
            .style("pointer-events", "none") // Чтобы текст не мешал взаимодействию
        ;

        // Функции для drag&drop
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Обновление позиций при симуляции
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);

            label
                .attr("x", d => d.x)
                .attr("y", d => d.y);

        });

        // Функция подсветки связанных элементов
        function highlightConnected(d) {
            // Сбрасываем предыдущую подсветку
            node.classed("highlighted", false);
            link.classed("linked-highlight", false);

            // Подсвечиваем выбранный узел
            d3.select(this).classed("highlighted", true);

            // Находим связанные рёбра
            const connectedLinks = graph.links.filter(link => 
                link.source.id === d.id || link.target.id === d.id
            );

            // Подсвечиваем связанные рёбра
            link.filter(l => connectedLinks.includes(l))
                .classed("linked-highlight", true);

            // Находим связанные узлы
            const connectedNodes = [];
            connectedLinks.forEach(link => {
                if (link.source.id !== d.id) connectedNodes.push(link.source.id);
                if (link.target.id !== d.id) connectedNodes.push(link.target.id);
            });

            // Подсвечиваем связанные узлы
            node.filter(n => connectedNodes.includes(n.id))
                .classed("highlighted", true);
        }

        // Добавляем обработчики событий
        // node.on("mouseover", function(event, d) {
        //     highlightConnected.call(this, d);
        // });

        node.on("click", function(event, d) {
            // При клике фиксируем подсветку
            highlightConnected.call(this, d);
            event.stopPropagation();

            // Скрываем все остальные tooltip
            hideAllTooltips();

            // Показываем tooltip для текущего узла
            showTooltip.call(this, event, d);

        });

        // Сброс подсветки при клике на пустое место
        svg.on("click", () => {
            node.classed("highlighted", false);
            link.classed("linked-highlight", false);
            if (event.target === this) {
                hideAllTooltips();
            }
        });

        // Подсветка рёбер при наведении
        // link.on("mouseover", function(event, d) {
        //     // Сбрасываем подсветку
        //     node.classed("highlighted", false);
        //     link.classed("linked-highlight", false);

        //     // Подсвечиваем ребро
        //     d3.select(this).classed("linked-highlight", true);

        //     // Подсвечиваем связанные узлы
        //     node.filter(n => n.id === d.source.id || n.id === d.target.id)
        //         .classed("highlighted", true);
        // });
        // Функция для показа tooltip
        function showTooltip(event, d) {
            tooltip.transition()
                .duration(200)
                .style("opacity", 0.9);

            tooltip.html(`
                <h3>${d.name || d.id}</h3>
                <p><strong>ID:</strong> ${d.id}</p>
                <p><strong>Группа:</strong> ${d.group}</p>
                <p><strong>Описание:</strong> ${d.description || 'Нет описания'}</p>
            `)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 28) + "px");

            // Подсвечиваем узел
            d3.select(this)
                .classed("highlight", true)
                .attr("r", 15);
        }

        // Функция для скрытия tooltip
        function hideTooltip(event, d) {
            tooltip.transition()
                .duration(500)
                .style("opacity", 0);

            // Убираем подсветку
            d3.select(this)
                .classed("highlight", false)
                .attr("r", 10);
        }

        function hideAllTooltips() {
            tooltip.transition()
                .duration(500)
                .style("opacity", 0);

            node.classed("highlight", false)
                .attr("r", 10);
        }


    </script>
</body>
</html>