<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>D3 TEST</title>
    <style>
    .node {
        stroke: #fff;
        stroke-width: 1.5px;
        cursor: pointer;
    }

    .link {
        stroke: #999;
        stroke-opacity: 0.6;
    }

    .node:hover {
        stroke: #000;
        stroke-width: 3px;
    }

    .link:hover {
        stroke: #ff0000;
        stroke-width: 3px;
    }

    .highlighted {
        stroke: #ff0000;
        stroke-width: 3px;
        fill: #ffcccc !important;
    }

    .linked-highlight {
        stroke: #ff0000;
        stroke-opacity: 1;
        stroke-width: 2px;
    }

    .side-tooltip {
        position: fixed;
        top: 50%;
        right: 20px;
        transform: translateY(-50%);
        width: 300px;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        font-family: Arial, sans-serif;
        font-size: 14px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
        max-height: 80vh;
        overflow-y: auto;
    }

    .side-tooltip.visible {
        opacity: 1;
    }

    .tooltip-header {
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .tooltip-content {
        line-height: 1.6;
    }

    .highlight {
        stroke: #ff0000;
        stroke-width: 3px;
    }


    </style>
</head>
<body>
    <div id="graph"></div>
    <div id="sideTooltip" class="side-tooltip"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // Данные графа
        const graph = {
            nodes: [
                {id: 0, short_name: "Савва Мамонтов", abr_name: "С.И. Мамонтов", group: "Меценат", full_name: "Савва Иванович Мамонтов", description: "Описание Мамонтов", group_id: 2},
                {id: 1, short_name: "Василий Поленов", abr_name: "В.Д. Поленов", group: "Художник", full_name: "Василий Дмитриевич Поленов", description: "Описание Поленов", group_id: 0},
                {id: 2, short_name: "Илья Репин", abr_name: "И.Е. Репин", group: "Художник", full_name: "Илья Ефимович Репин", description: "Описание Репин", group_id: 0},
                {id: 3, short_name: "Сергей Рахманинов", abr_name: "С.В. Рахманинов", group: "Музыкант", full_name: "Сергей Васильевич Рахманинов", description: "Описание Рахманинов", group_id: 1},
                {id: 4, short_name: "Николай Римский-Корсаков", abr_name: "Н.А. Римский-Корсаков", group: "Музыкант", full_name: "Николай Андреевич Римский-Корсаков", description: "Описание Римский-Корсаков", group_id: 1}
            ],
            links: [
                {source: 0, target: 1, full_name_1: "Савва Иванович Мамонтов", full_name_2: "Василий Дмитриевич Поленов", description: "Описание Мамонтов - Поленов"},
                {source: 0, target: 2, full_name_1: "Савва Иванович Мамонтов", full_name_2: "Илья Ефимович Репин", description: "Описание Мамонтов - Репин"},
                {source: 0, target: 3, full_name_1: "Савва Иванович Мамонтов", full_name_2: "Сергей Васильевич Рахманинов", description: "Описание Мамонтов - Рахманинов"},
                {source: 0, target: 4, full_name_1: "Савва Иванович Мамонтов", full_name_2: "Николай Андреевич Римский-Корсаков", description: "Описание Мамонтов - Корсаков"},
                {source: 1, target: 2, full_name_1: "Василий Дмитриевич Поленов", full_name_2: "Илья Ефимович Репин", description: "Описание Поленов - Репин"}
            ]
        };

        const width = 800, height = 600;

        // Создание SVG
        const svg = d3.select("#graph")
            .append("svg")
            .attr("width", width)
            .attr("height", height);
        const sideTooltip = d3.select("#sideTooltip");

        // Инициализация симуляции
        const simulation = d3.forceSimulation(graph.nodes)
            .force("link", d3.forceLink(graph.links).id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2));

        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // Создание линий (рёбра)
        const link = svg.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(graph.links)
            .enter().append("line")
            .attr("class", "link")
            .attr("stroke-width", 2);

        // Создание узлов
        const node = svg.append("g")
            .attr("class", "nodes")
            .selectAll("circle")
            .data(graph.nodes)
            .enter().append("circle")
            .attr("class", "node")
            .attr("r", 10)
            .attr("fill", d => d3.schemeCategory10[d.group_id])
            .call(
                d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended)
            );

        // Добавление подписей
        const label = svg.append("g")
            .attr("class", "labels")
            .selectAll("text")
            .data(graph.nodes)
            .enter().append("text")
            .text(d => d.abr_name)
            .attr("font-size", 14)
            .attr("dx", 0)
            .attr("dy", 20)
            .attr("text-anchor", "middle")
            .style("pointer-events", "none") // Чтобы текст не мешал взаимодействию
        ;

        // Функции для drag&drop
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Обновление позиций при симуляции
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);

            label
                .attr("x", d => d.x)
                .attr("y", d => d.y);

        });

        // Переменные для отслеживания состояния
        let selectedNode = null;
        let selectedLink = null;

        // Обработчики событий для узлов
        node.on("click", function(event, d) {
            event.stopPropagation();

            if (selectedNode === null) {
                // Первый клик - выбираем узел
                selectedNode = d;
                node.classed("selected", false);
                d3.select(this).classed("selected", true);
                showNodeInfo(d);

                // Подсвечиваем смежные узлы
                const connectedNodeIds = new Set();
                graph.links.forEach(link => {
                    if (link.source.id === d.id) connectedNodeIds.add(link.target.id);
                    if (link.target.id === d.id) connectedNodeIds.add(link.source.id);
                });

                node.filter(node => connectedNodeIds.has(node.id))
                    .classed("highlight", true)
                    .attr("r", 14);

            } else if (selectedNode.id !== d.id) {
                // Второй клик на другом узле - показываем связь
                const linkData = getLinkBetweenNodes(selectedNode.id, d.id);
                if (linkData) {
                    selectedLink = linkData;
                    showLinkInfo(linkData, selectedNode, d);

                    // Подсвечиваем связь
                    link.classed("link-highlight", false);
                    link.filter(l => l === linkData)
                        .classed("link-highlight", true);
                }
            }
        });


        // Сброс подсветки при клике на пустое место
        svg.on("click", () => {
            node.classed("highlighted", false);
            link.classed("linked-highlight", false);
            // hideSideTooltip();
            resetSelection();
        });

        // Функция для показа бокового tooltip
        function showNodeInfo(d) {
            // Подсвечиваем узел
            node.classed("highlight", false);
            d3.select(`circle[node-id="${d.id}"]`).classed("highlight", true);

            // Заполняем tooltip содержимым
            sideTooltip.html(`
                <div class="tooltip-header">
                    <h2 style="margin: 0; color: #2c3e50;">${d.full_name}</h2>
                    <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 12px;">ID: ${d.id}</p>
                </div>

                <div class="tooltip-content">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div style="font-size: 11px; color: #7f8c8d;">group</div>
                            <div style="font-size: 18px; font-weight: bold; color: ${d3.schemeCategory10[d.group_id]};">${d.group}</div>
                        </div>
                            <div style="font-size: 11px; color: #7f8c8d;">name</div>
                            <div style="font-size: 18px; font-weight: bold; color: #e74c3c;">${d.full_name}</div>
                        </div>
                        <div class="stat-item">
                            <div style="font-size: 11px; color: #7f8c8d;">description</div>
                            <div style="font-size: 14px; font-weight: bold; color: #34495e;">${d.description}</div>
                        </div>
                    </div>
                </div>
            `);

            // Показываем tooltip
            sideTooltip.classed("visible", true);
        }

        // Функция для показа информации о связи
        function showLinkInfo(linkData, sourceNode, targetNode) {
            sideTooltip.html(`
                <div class="tooltip-header">
                    <h2 style="margin: 0; color: #2c3e50;">Связь: ${sourceNode.name} → ${targetNode.name}</h2>
                </div>

                <div style="line-height: 1.6;">
                    <p>${linkData.description}</p>
                </div>
            `);

            sideTooltip.classed("visible", true);
        }

        // Функция для скрытия tooltip
        function hideSideTooltip() {
            sideTooltip.classed("visible", false);
            node.classed("highlight", false);
        }

        node.attr("node-id", d => d.id);

        // Скрытие при нажатии ESC
        d3.select("body").on("keydown", function(event) {
            if (event.key === "Escape") {
                resetSelection();
            }
        });

        // Функция сброса выделения
        function resetSelection() {
            selectedNode = null;
            selectedLink = null;

            node.classed("highlight", false)
                .classed("selected", false)
                .attr("r", 12);

            link.classed("link-highlight", false);

            sideTooltip.classed("visible", false);
        }

        // Функция для получения связи между двумя узлами
        function getLinkBetweenNodes(node1Id, node2Id) {
            return graph.links.find(link =>
                (link.source.id === node1Id && link.target.id === node2Id) ||
                (link.source.id === node2Id && link.target.id === node1Id)
            );
        }


    </script>
</body>
</html>