<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Русская художественная культура в конце XIX — начале ХХ в.</title>
    <style>
    .node-container {
        --node-size: 30px;
        --image-size: calc(var(--node-size) * 2);
        --image-offset: calc(var(--image-size) / 2);
        --scale: 1;

        transition: opacity 0.3s ease;
        cursor: pointer;
    }
    .node-circle {
        r: var(--node-size);
        transition: inherit;

    }
    .node-image {
        width: var(--image-size);
        height: var(--image-size);
        x: calc(-1 * var(--image-offset));
        y: calc(-1 * var(--image-offset));
        clip-path: circle(calc(var(--image-offset) - 3px));
        transition: inherit;
    }
    .node-container.highlight {
        --node-size: 37px;
        filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 1));
    }
    .node-container.dim {
        opacity: 0.2;
    }

    .label-container {
        --label-corner-radius: 6px;
        --label-padding-x: 8px;
        --label-padding-y: 4px;
        --label-font-size: 13px;
        --bg-opacity: 1;

        opacity: 1;
        pointer-events: none;
        cursor: pointer;
        transition: opacity 0.3s ease;
    }
    .label-bg {
        rx: var(--label-corner-radius);
        ry: var(--label-corner-radius);
        fill: rgba(255, 255, 255, var(--bg-opacity));
        stroke: #cccccc;
        stroke-width: 1px;
        transition: inherit;
        opacity: inherit;

    }
    .label-text {
        font-size: var(--label-font-size);
        text-anchor: middle;
        dominant-baseline: central;
        transition: inherit;
        opacity: inherit;
        pointer-events: none;
        user-select: none;
    }
    .label-container.dim {
        opacity: 0;
    }
    .label-container.highlight {
        --bg-opacity: 1;
    }


    .link {
        stroke: #999;
        stroke-opacity: 0.6;
        stroke-width: 3.0px;
        transition: opacity 0.3s ease;
    }
    .link.dim {
        stroke-opacity: 0.1 !important;
    }
    .link.highlight {
        stroke-opacity: 1 !important;
        stroke-width: 3px !important;
        stroke: #922 !important;
    }
    /* Стили для разных типов связей */
    .link[data-type="friend-1"] {
        stroke: #999;
        stroke-width: 2.0px;
        stroke-dasharray: 5,5;
        stroke-opacity: 0.6;
    }

    .link[data-type="friend-2"] {
        stroke: #999;
        stroke-width: 1.5px;
        stroke-dasharray: 5,5;
        stroke-opacity: 0.4;
    }

    .link[data-type="friend-3"] {
        stroke: #999;
        stroke-width: 1.0px;
        stroke-dasharray: 5,5;
        stroke-opacity: 0.2;
    }

    .link[data-type="apprentice"] {
        stroke: #999;
        stroke-width: 2.0px;
        stroke-opacity: 0.6;
    }

    .link[data-type="family"] {
        stroke: #999;
        stroke-width: 2.0px;
        stroke-opacity: 0.6;
    }

    .side-tooltip {
        position: fixed;
        top: 50%;
        right: 20px;
        transform: translateY(-50%);
        width: 300px;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        font-family: Arial, sans-serif;
        font-size: 14px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
        max-height: 80vh;
        overflow-y: auto;
    }

    .side-tooltip.visible {
        opacity: 1;
    }

    .tooltip-header {
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .tooltip-content {
        line-height: 1.6;
    }



    </style>
</head>
<body>
    <div id="graph"></div>
    <div id="sideTooltip" class="side-tooltip"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // Данные графа
        const graph = {
            nodes: [
                {id: 0, short_name: "Савва Мамонтов", abr_name: "С.И. Мамонтов", img: "mamontov_si.png", group: "Меценат", full_name: "Савва Иванович Мамонтов", tags: ["Абрамцевский кружок", "Мамонтовская опера"], description: "Описание Мамонтов", group_id: 3},
                {id: 1, short_name: "Василий Поленов", abr_name: "В.Д. Поленов", img: "polenov_vd.png", group: "Художник", full_name: "Василий Дмитриевич Поленов", tags: ["Абрамцевский кружок", "Мамонтовская опера"], description: "Описание Поленов", group_id: 4},
                {id: 2, short_name: "Елена Поленова", abr_name: "Е.Д. Поленова", img: "polenova_ed.png", group: "Художник", full_name: "Елена Дмитриевна Поленова", tags: ["Абрамцевский кружок"], description: "Описание Поленова", group_id: 4},
                {id: 3, short_name: "Илья Репин", abr_name: "И.Е. Репин", img: "repin_ie.png", group: "Художник", full_name: "Илья Ефимович Репин", tags: ["Абрамцевский кружок"], description: "Описание Репин", group_id: 4},
                {id: 4, short_name: "Константин Коровин", abr_name: "К.А. Коровин", img: "korovin_ka.png", group: "Художник", full_name: "Константин Алексеевич Коровин", tags: ["Абрамцевский кружок", "Мамонтовская опера", "Союз русских художников"], description: "Описание Коровин", group_id: 4},
                {id: 5, short_name: "Валентин Серов", abr_name: "В.А. Серов", img: "serov_vi.png", group: "Художник", full_name: "Валентин Александрович Серов", tags: ["Абрамцевский кружок", "Мамонтовская опера", "Мирискусники"], description: "Описание Серов", group_id: 4},
                {id: 6, short_name: "Михаил Врубель", abr_name: "М.А. Врубель", img: "vrubel_ma.png", group: "Художник", full_name: "Михаил Александрович Врубель", tags: ["Абрамцевский кружок", "Мамонтовская опера"], description: "Описание Врубель", group_id: 4},
                {id: 7, short_name: "Сергей Рахманинов", abr_name: "С.В. Рахманинов", img: "rahmaninov_sv.png", group: "Музыкант", full_name: "Сергей Васильевич Рахманинов", tags: ["Мамонтовская опера"], description: "Описание Рахманинов", group_id: 0},
                {id: 8, short_name: "Николай Римский-Корсаков", abr_name: "Н.А. Римский-Корсаков", img: "rimsky-korsakov_na.png", group: "Музыкант", full_name: "Николай Андреевич Римский-Корсаков", tags: ["Мамонтовская опера"], description: "Описание Римский-Корсаков", group_id: 0},
                {id: 9, short_name: "Марк Антокольский", abr_name: "М.М. Антокольский", img: "antokolsky_mm.png", group: "Скульптор", full_name: "Марк Матвеевич Антокольский", tags: ["Абрамцевский кружок"], description: "nan", group_id: 2},
                {id: 10, short_name: "Виктор Гартман", abr_name: "В.А. Гартман", img: "gartman_va.png", group: "Архитектор", full_name: "Виктор Александрович Гартман", tags: [], description: "nan", group_id: 5},
                {id: 11, short_name: "Сергей Боткин", abr_name: "С.П. Боткин", img: "botkin_sp.png", group: "Ученый", full_name: "Сергей Петрович Боткин", tags: [], description: "nan", group_id: 1},
                {id: 12, short_name: "Михаил Иванов", abr_name: "М.М. Иванов", img: "ivanov_mm.png", group: "Критик", full_name: "Михаил Михайлович Иванов", tags: [], description: "nan", group_id: 6},
                {id: 13, short_name: "Адриан Прахов", abr_name: "А.В. Прахов", img: "prahov_av.png", group: "Критик", full_name: "Адриан Викторович Прахов", tags: [], description: "nan", group_id: 6}
            ],
            links: [
                {source: 0, target: 1, type: "friend-1", full_name_1: "Савва Иванович Мамонтов", full_name_2: "Василий Дмитриевич Поленов", description: "Описание Мамонтов - Поленов"},
                {source: 0, target: 3, type: "friend-1", full_name_1: "Савва Иванович Мамонтов", full_name_2: "Илья Ефимович Репин", description: "Описание Мамонтов - Репин"},
                {source: 0, target: 7, type: "friend-2", full_name_1: "Савва Иванович Мамонтов", full_name_2: "Сергей Васильевич Рахманинов", description: "Описание Мамонтов - Рахманинов"},
                {source: 0, target: 8, type: "friend-2", full_name_1: "Савва Иванович Мамонтов", full_name_2: "Николай Андреевич Римский-Корсаков", description: "Описание Мамонтов - Корсаков"},
                {source: 0, target: 5, type: "friend-1", full_name_1: "Савва Иванович Мамонтов", full_name_2: "Валентин Александрович Серов", description: "nan"},
                {source: 0, target: 6, type: "friend-1", full_name_1: "Савва Иванович Мамонтов", full_name_2: "Михаил Александрович Врубель", description: "nan"},
                {source: 0, target: 4, type: "friend-1", full_name_1: "Савва Иванович Мамонтов", full_name_2: "Константин Алексеевич Коровин", description: "nan"},
                {source: 0, target: 12, type: "friend-2", full_name_1: "Савва Иванович Мамонтов", full_name_2: "Михаил Михайлович Иванов", description: "nan"},
                {source: 0, target: 10, type: "friend-2", full_name_1: "Савва Иванович Мамонтов", full_name_2: "Виктор Александрович Гартман", description: "nan"},
                {source: 0, target: 13, type: "friend-2", full_name_1: "Савва Иванович Мамонтов", full_name_2: "Адриан Викторович Прахов", description: "nan"},
                {source: 3, target: 5, type: "apprentice", full_name_1: "Илья Ефимович Репин", full_name_2: "Валентин Александрович Серов", description: "nan"},
                {source: 5, target: 4, type: "friend-1", full_name_1: "Валентин Александрович Серов", full_name_2: "Константин Алексеевич Коровин", description: "nan"},
                {source: 1, target: 3, type: "friend-1", full_name_1: "Василий Дмитриевич Поленов", full_name_2: "Илья Ефимович Репин", description: "Описание Поленов - Репин"},
                {source: 1, target: 2, type: "family", full_name_1: "Василий Дмитриевич Поленов", full_name_2: "Елена Дмитриевна Поленова", description: "Описание Поленов - Поленова"},
                {source: 9, target: 0, type: "friend-1", full_name_1: "Марк Матвеевич Антокольский", full_name_2: "Савва Иванович Мамонтов", description: "nan"},
                {source: 9, target: 10, type: "friend-2", full_name_1: "Марк Матвеевич Антокольский", full_name_2: "Виктор Александрович Гартман", description: "nan"},
                {source: 9, target: 11, type: "friend-3", full_name_1: "Марк Матвеевич Антокольский", full_name_2: "Сергей Петрович Боткин", description: "nan"},
                {source: 9, target: 12, type: "friend-1", full_name_1: "Марк Матвеевич Антокольский", full_name_2: "Михаил Михайлович Иванов", description: "nan"}
            ]
        };

        const width = 1600, height = 800;

        // Создание SVG
        const svg = d3.select("#graph")
            .append("svg")
            .attr("width", width)
            .attr("height", height);
        const sideTooltip = d3.select("#sideTooltip");

        // Инициализация симуляции
        const simulation = d3.forceSimulation(graph.nodes)
            .force("link", d3.forceLink(graph.links).id(d => d.id).distance(120))
            .force("charge", d3.forceManyBody().strength(-400))
            .force("center", d3.forceCenter(width / 2, height / 2));

        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);


        const link = svg.append("g")
            .selectAll("line")
            .data(graph.links)
            .enter().append("line")
            .attr("class", "link")
            .attr("data-type", l => l.type); // Сохраняем тип в data-атрибуте
            // .classed(l => l.type, true);


        const node = svg.append("g")
            .selectAll("g")
            .data(graph.nodes)
            .enter().append("g")
            .attr("class", "node-container")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended)
            );
        node.append("circle")
            .attr("class", "node-circle")
            .attr("fill", d => d3.schemeCategory10[d.group_id]);
        node.append("image")
            .attr("class", "node-image")
            .attr("xlink:href", d => {
                if (d.img === "nan" || d.img === "") return "images/default.png";
                return "images/" + d.img;
            });


        const label = svg.append("g")
            .selectAll("g")
            .data(graph.nodes)
            .enter().append("g")
            .attr("class", "label-container");
        label.append("rect")
            .attr("class", "label-bg");
        label.append("text")
            .text(d => d.abr_name)
            .attr("class", "label-text")
            .attr("dy", "35px");

        // Функции для drag&drop
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Обновление позиций при симуляции
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node.attr("transform", d => `translate(${d.x},${d.y})`);
            label.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        // Переменные для отслеживания состояния
        let selectedNode = null;
        let selectedLink = null;


        // Обработчики событий для узлов
        node.on("click", function(event, d) {
            event.stopPropagation();

            if (selectedNode === null && !node.classed("node-container.dim")) {
                
                selectedNode = d;
                setValueNodes("highlight", false);
                setValueNode(selectedNode, "highlight", true);
                showNodeInfo(selectedNode);

                const connectedNodeIds = new Set();
                graph.links.forEach(link => {
                    if (link.source.id === selectedNode.id) connectedNodeIds.add(link.target.id);
                    if (link.target.id === selectedNode.id) connectedNodeIds.add(link.source.id);
                });

                graph.nodes
                    .filter(n => !connectedNodeIds.has(n.id) && n.id != selectedNode.id)
                    .forEach(n => setValueNode(n, "dim", true));

                graph.links
                    .filter(l => l.source.id != selectedNode.id && l.target.id != selectedNode.id)
                    .forEach(l => setValueLink(l, "dim", true));

            } else if (selectedNode.id !== d.id & !node.classed("node-container.dim")) {
                selectedNode2 = d;
                setValueNodes("highlight", false);
                setValueNode(selectedNode, "highlight", true);
                setValueNode(selectedNode2, "highlight", true);

                setValueLinks("highlight", false)
                const selectedLink = graph.links.find(l =>
                    (l.source.id === selectedNode.id && l.target.id === d.id) ||
                    (l.target.id === selectedNode.id && l.source.id === d.id)
                );
                if (selectedLink) {
                    setValueNode(d, "highlight", true);
                    setValueLink(selectedLink, "highlight", true)
                    showLinkInfo(selectedLink, selectedNode, d);
                }
            } else if (selectedNode.id === d.id) {
                setValueNodes("highlight", false);
                setValueLinks("highlight", false);
                setValueNode(selectedNode, "highlight", true);
                showNodeInfo(selectedNode);
            }
        });


        // Сброс подсветки при клике на пустое место
        svg.on("click", () => {
            resetSelection();
        });

        // Функция для показа бокового tooltip
        function showNodeInfo(d) {
            // Подсвечиваем узел
            // node.classed("node-container.highlight", false);

            // d3.select(`circle[node-id="${d.id}"]`).classed("node-container.highlight", true);

            // Заполняем tooltip содержимым
            sideTooltip.html(`
                <div class="tooltip-header">
                    <h2 style="margin: 0; color: #2c3e50;">${d.full_name}</h2>
                </div>

                <div class="tooltip-content">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div style="font-size: 11px; color: #7f8c8d;">description</div>
                            <div style="font-size: 14px; font-weight: bold; color: #34495e;">${d.description}</div>
                        </div>
                    </div>
                </div>
            `);

            // Показываем tooltip
            sideTooltip.classed("visible", true);
        }

        // Функция для показа информации о связи
        function showLinkInfo(linkData, sourceNode, targetNode) {
            sideTooltip.html(`
                <div class="tooltip-header">
                    <h2 style="margin: 0; color: #2c3e50;">Связь: ${sourceNode.abr_name} → ${targetNode.abr_name}</h2>
                </div>

                <div style="line-height: 1.6;">
                    <p>${linkData.description}</p>
                </div>
            `);

            sideTooltip.classed("visible", true);
        }


        // Скрытие при нажатии ESC
        d3.select("body")
            .on("keydown", function(event) {
            if (event.key === "Escape") {
                resetSelection();
            }
            });

        // Функция сброса выделения
        function resetSelection() {
            setValueLinks("dim", false);
            setValueNodes("dim", false);

            setValueLinks("highlight", false);
            setValueNodes("highlight", false);

            selectedNode = null;
            selectedLink = null;

            // node.classed("node-container.highlight", false)
            //     .classed("selected", false);

            // link.classed("link-highlight", false);

            sideTooltip.classed("visible", false);
        }

        function createListControls() {
            // Простая проверка - выводим в консоль
            console.log("Создаем панель управления...");

            const allTags = [...new Set(graph.nodes.flatMap(node => node.tags))];

            // Создаем самый простой вариант
            const controls = d3.select("body")
                .append("div")
                .html(`
                    <div style="
                        position: fixed;
                        top: 20px;
                        left: 20px;
                        background: white;
                        padding: 20px;
                        border-radius: 10px;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                        z-index: 10000;
                        border: 1px solid black;
                    ">
                        <div style="margin-bottom: 15px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 16px;">Общества, объединения, кружки</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                ${allTags.map(tag => `
                                    <button onclick="filterNodesByTag('${tag}')"
                                            style="color: black; border: none;
                                                   padding: 4px 8px; border-radius: 12px; font-size: 11px; cursor: pointer;">
                                        ${tag}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                    </div>
                `);


            console.log("Панель создана");
        }

        // Функция для фильтрации узлов по тегам
        function filterNodesByTag(tag) {
            setValueNodes("dim", false);
            setValueLinks("dim", false)

            const nonTaggedNodes = graph.nodes.filter(node => !node.tags.includes(tag));
            const nonTaggedNodesIds = new Set(nonTaggedNodes.map(n => n.id));

            graph.links
                .filter(l => nonTaggedNodesIds.has(l.source.id) ||
                             nonTaggedNodesIds.has(l.target.id))
                .forEach(l => setValueLink(l, "dim", true));

            graph.nodes
                .filter(n => nonTaggedNodesIds.has(n.id))
                .forEach(n => setValueNode(n, "dim", true));
        }


        function setValueNode(targetNode, key, value) {
            d3
                .selectAll(".node-container")
                .filter(d => targetNode === d)
                .classed(key, value);

            d3
                .selectAll(".label-container")
                .filter(d => targetNode === d)
                .classed(key, value);
        }

        function setValueNodes(key, value) {
            d3
                .selectAll(".node-container")
                .classed(key, value);
            d3
                .selectAll(".label-container")
                .classed(key, value);
        }

        function setValueLink(targetLink, key, value) {
            link
                .filter(l => l === targetLink)
                .classed(key, value);
        }

        function setValueLinks(key, value) {
            link.classed(key, value);
        }

        // Тестируем
        createListControls();

        function updateLabelBackgrounds() {
            label.select(".label-bg")
                .each(function(d) {
                    const textElement = this.nextSibling; // Следующий элемент - текст
                    const bbox = textElement.getBBox();

                    d3.select(this)
                        .attr("x", bbox.x - 4) // Отступы
                        .attr("y", bbox.y - 2)
                        .attr("width", bbox.width + 8)
                        .attr("height", bbox.height + 4);
                });
        }

        // Вызываем после создания и при обновлении
        setTimeout(updateLabelBackgrounds, 10);


    </script>
</body>
</html>